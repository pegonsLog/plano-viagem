<div class="checklist-container">
  <div class="checklist-page-container">
    <div class="header">
      <div class="header-content">
        <button class="btn-voltar" (click)="voltarParaLista()" title="Voltar para a lista de viagens">
          <app-icon name="arrow-left" [size]="20"></app-icon>
        </button>
        <h2><app-icon name="clipboard-list" [size]="24"></app-icon> Checklist da Viagem</h2>
      </div>
      <button class="btn-adicionar" (click)="abrirFormulario()">
        <app-icon name="plus" [size]="18"></app-icon>
        Adicionar Item
      </button>
    </div>

    @if (loading()) {
    <div class="loading-container">
      <app-icon name="arrow-path" [size]="32" color="#6b7280"></app-icon>
      <p>Carregando itens...</p>
    </div>
    }

    @if (!loading()) {
      <div class="tabela-wrapper">
        <table class="tabela-checklist">
          <thead>
            <tr>
              <th class="col-status">Status</th>
              <th class="col-descricao">Item</th>
              <th class="col-acoes">Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (item of checklistItems$ | async; track item.id) {
            <tr [class.concluido]="item.concluido">
              <td class="col-status">
                <input type="checkbox" [checked]="item.concluido" (change)="toggleConcluido(item.id, !item.concluido)" (click)="$event.stopPropagation()">
              </td>
              <td class="col-descricao">
                <span>{{ item.descricao }}</span>
              </td>
              <td class="col-acoes">
                <button class="btn-acao editar" (click)="abrirFormulario(item)" title="Editar item">
                  <app-icon name="pencil" [size]="16"></app-icon>
                </button>
                <button class="btn-acao remover" (click)="abrirConfirmacaoRemover(item.id)" title="Remover item">
                  <app-icon name="trash" [size]="16"></app-icon>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      @if ((checklistItems$ | async)?.length === 0) {
      <div class="sem-dados">
        <app-icon name="clipboard-list" [size]="48" color="#9ca3af"></app-icon>
        <h3>Nenhum item no checklist</h3>
        <p>Clique em "Adicionar Item" para começar.</p>
      </div>
      }
    }
  </div>

  <!-- Modal para Adicionar/Editar Item -->
  @if (isFormularioAberto()) {
  <div class="modal-overlay" (click)="fecharFormulario()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ itemSelecionado() ? 'Editar Item' : 'Adicionar Item' }}</h3>
        <button class="btn-fechar" (click)="fecharFormulario()">
          <app-icon name="x-mark" [size]="20"></app-icon>
        </button>
      </div>
      <div class="modal-content">
        <form [formGroup]="itemForm" (ngSubmit)="salvarItem()">
          <div class="form-group">
            <label for="descricao">Descrição do item</label>
            <input type="text" id="descricao" formControlName="descricao" required cdkFocusInitial>
            @if (itemForm.get('descricao')?.invalid && itemForm.get('descricao')?.touched) {
            <div class="error-message">A descrição é obrigatória.</div>
            }
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-cancelar" (click)="fecharFormulario()">Cancelar</button>
            <button type="submit" class="btn-salvar" [disabled]="itemForm.invalid">
              <app-icon name="check" [size]="18"></app-icon> Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  <!-- Modal de Confirmação para Remover Item -->
  @if (isConfirmacaoRemoverAberto()) {
  <div class="modal-overlay" (click)="fecharConfirmacaoRemover()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3><app-icon name="exclamation-circle" [size]="20"></app-icon> Confirmar Remoção</h3>
        <button class="btn-fechar" (click)="fecharConfirmacaoRemover()">
          <app-icon name="x-mark" [size]="20"></app-icon>
        </button>
      </div>
      <div class="modal-content">
        <p>Você tem certeza de que deseja remover este item do checklist?</p>
        <p>Esta ação não pode ser desfeita.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-cancelar" (click)="fecharConfirmacaoRemover()">Cancelar</button>
        <button type="button" class="btn-remover-confirmar" (click)="confirmarRemocao()">
          <app-icon name="trash" [size]="16"></app-icon> Sim, Remover
        </button>
      </div>
    </div>
  </div>
  }
</div>
